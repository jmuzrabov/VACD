<!DOCTYPE html>
<html>
<head>
	<title>VACD</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png" sizes="32x32" href="meta/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="meta/favicon-16x16.png">
	<link rel="icon" type="image/png" href="meta/favicon.ico">
	<link rel="mask-icon" href="meta/safari-pinned-tab.svg" color="#ce470a">
	<link rel="stylesheet" type="text/css" href="css/_plug/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/forms.css">
	<link rel="stylesheet" type="text/css" href="css/yd.css">
	<link rel="stylesheet" type="text/css" href="css/buttons.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" href="./js/jq/jquery-ui.min.css">
	<script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script>

</head>
<body translate="no">
	<article class="row no-gutters">
		<aside class="col-auto">
			<a href="/" class="logo bone"><div></div></a>
			<nav class="bone mb-5" id="back"></nav>
			<nav class="bone" id="nav">
				<a href="reteflow_number.html" id="telNumber" >Nummer</a>
				<a href="reteflow_callflow.html" id="callflow">Callflow</a>
				<a href="reteflow_sound.html" id="sound">Sounds</a>
			</nav>
			<footer>
				<nav class="bone">
					<!-- <a href="#" id="test">TEST</a> -->
					<!-- <a href="#" id="generator">Generate</a> -->
				</nav>

				<small  id="logout">
					<a href="index.html">abmelden
						<!-- <img src="//assets.yoummday.com/icons/mdi-reload.svg?color=%23eb6608" style="width:16px;"> -->
					</a>
				</small>
			</footer>
		</aside>
		<div class="col row no-gutters flex-column">
			<header class="bone text-center">
				<div class="row">
					<div class="container p-2">
						<div class="row justify-content-between">
					    <div class="col-4">
					      <span class="font-weight-bold text-uppercase "><label id="custom" ></label></span>
								<!-- <span class="iconify" data-icon="mdi:arrow-left-bold-circle-outline" data-inline="false"></span> -->
					    </div>
					    <div class="col-4">
					      <span class="font-weight-bold text-uppercase" id="head"><label for="worktype_label" id="worktype_label"></label></span>
					    </div>
					  </div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-8"></div>
				</div>
			</header>
			<div class="content col">

				<!-- Editor und Anrufverlaufliste -->
				<div class="row justify-content-around editorbox">
					<!-- Leftsite / Editor -->
					<div class="col-sm-6 col-md-9" id="leftSite">
						<!-- Sound -->
						<div class="card" id='divSOUNDUPLOAD'>
							<div class="card-body">
								<div class="row">
									<!-- Sound upload-->
									<div class="col">
										<div class="justify-content-around ">
											<div class="col" id="divSOUNDLIST">
												<h3>Sounds</h3>
												<ul id="sounds"></ul>
												<div id="showSoundlist"></div>
											</div><!-- divSOUNDLIST-->
											<div class="col extBtn mt-5">
												<h3>Upload</h3>
												<form id="uploadFORM" enctype='multipart/form-data'>
													<input type="file" name="file" value="" id="inputFILE"><br>
													<div class="justify-content-between mt-3">
														<input type="button" class="button btn btn-primary" value="UPLOAD" id="btnUPLOAD">
													</div>
												</form>
											</div><!-- soundUPLOAD-->
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
		</div>
		<div class="modal d-none" tabindex="-1">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title alert-warning">ACHTUNG!</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <p>Wollen Sie wirklich löschen?</p>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-outline-primary" data-dismiss="modal">nein</button>
		        <button type="button" class="btn btn-outline-primary" id="ja">ja</button>
		      </div>
		    </div>
		  </div>
		</div>
	</article>


	<script src="./js/jquery-3.5.1.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="./js/jq/vendor/jquery.ui.widget.js"></script>
	<script src="./js/jq/jquery.iframe-transport.js"></script>
	<script src="./js/jq/jquery.fileupload.js"></script>
	<script src="./js/dayjs.min.js"></script>
	<script src="./js/jq/jquery-ui.min.js"></script>

	<script type="text/javascript">

			function backendCall(funktionsname, successfunction) {
				$.ajax({
					type:'GET',
					contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
					dataType: 'json',
					data: {
									auth:localStorage.auth,
									couser:localStorage.couserID
								},
					url: 'https://apiqa.yoummday.com/vacd/'+funktionsname,
					success: function(result) {
						if ("error" in result) {
							if (result["error"] == "auth") {
								alert("WRONG AUTH");
							}

							console.log(result["error"]);
							return;
						}
						successfunction(result);
					}
						,
					error: function (e) {
						console.log(e);
					}
				});
			}

			function loadNumberContent() {

				//Userdaten auflisten
				backendCall("couserslist",function(result){
					let span = document.createElement('span');
					let timeLabel = $('#worktype_label');



					let header = $('#custom');
					let a = document.createElement('a');
					let divBack = $('#back');
					let aBack = document.createElement('a');

					let backSpan = document.createElement('span');
					backSpan.setAttribute('class','iconify');
					backSpan.setAttribute('data-icon','mdi:arrow-left-bold-circle-outline');
					backSpan.setAttribute('data-inline','false');
					backSpan.setAttribute('data-width','20px');
					backSpan.setAttribute('data-height','20px');
					backSpan.setAttribute('style','color:#eb6608');
					backSpan.setAttribute('style','margin-right:5px');
					let backA = document.createElement('a');

					if(window.localStorage.getItem('couserNAME')){

						a.setAttribute('href','#');
						a.appendChild(document.createTextNode(window.localStorage['couserNAME']));

						backA.setAttribute('href','menu.html');
						backA.appendChild(backSpan);

					}else{
						a.appendChild(document.createTextNode(window.localStorage['name']));
						// a.appendChild(document.createTextNode('Firma hat keine Name'));
					}
						header.append(a);
						header.append(backA);

					let aMenu1 = $('#callflow');
					let aMenu2 = $('#sound');
					let couserLenght = window.localStorage['couserLenght'];
					let fullaccess = window.localStorage['fullaccess'];

					if(couserLenght > 1 || fullaccess === true){
						aMenu1.removeClass('hidden');
						aMenu2.removeClass('hidden')
					}



				});

				//Soundliste anzeigen
				backendCall("soundlist",function(result){
						console.log('soundlist=>',result);

						if(Object.keys(result).length > 0) {

							let liste = result["soundlist"];
							Object.keys(liste).forEach(sound => {
								let sounds = liste[sound];
								let soundId = sounds["id"];
								let soundName = sounds["filename"];
								let soundUploadTS = sounds["uploadTS"];

								let div = $('#showSoundlist');

								let row = document.createElement('div');
								row.setAttribute('class','row');

								let colmd3_1 = document.createElement('div');
								colmd3_1.setAttribute('class','col-md-3');
								colmd3_1.append(soundName);

								let colmd3_2 = document.createElement('div');
								colmd3_2.setAttribute('class','col-md-3');
								colmd3_2.append(soundUploadTS);

								let colmd1 = document.createElement('div');
								colmd1.setAttribute('class','col-md-1');
								let a = document.createElement('a');
								a.setAttribute('href','#');
								a.setAttribute('data-form','{"soundid":'+ soundId +'}');
								a.setAttribute('id','soundId');
								let span = document.createElement('span');
								span.setAttribute('data-icon','mdi-close-circle');
								span.setAttribute('class','iconify alert-danger');

								a.append(span);
								colmd1.append(a);

								row.append(colmd3_1);
								row.append(colmd3_2);
								row.append(colmd1);

								div.append(row);
							});
						}	else{
								$('#showSoundlist').append('<p style="font-weight: bold; color:red">No sound files found!</p>');
							}


					});

			}



		$(document).ready(function(){

			//Sound Container anzeigen
			loadNumberContent();
			$('#sound').click(loadNumberContent);//$('#telNumber').click

			getSoundlist();
			let systemSoundlist = [];
			function getSoundlist(){
				let soundlistitem = {}; // {fileID: "", fileName: "", fileTS: "", deleteBtnId: ""}
				$.ajax({
					type: 'GET',
					contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
					dataType: "json",
					data:
					{
						auth: window.localStorage.getItem("auth"),
						couser: window.localStorage.getItem("couserID")
					},
					url: 'https://apiqa.yoummday.com/vacd/soundlist',
					success: function(result){
						// console.log('result=>',result);
						delete result["authTime"];
						delete result["success"];
						if(Object.keys(result).length > 0) {
							Object.keys(result).forEach(key => {
								if(Object.keys(result[key])){
									Object.keys(result[key]).forEach(index =>{
										if(result[key][index]['filename']){
											let fileName = result[key][index]["filename"];
											soundlistitem = {
												fileID: result[key][index]["id"],
												fileName: fileName,
												fileTS: result[key][index]["uploadTS"]
												// deleteBtnId: fileName.split(/\s/).join('')
											};
											// console.log('soundlistitem=>', soundlistitem);
											systemSoundlist.push(soundlistitem);
										}
										else{
											soundlistitem = {};
										}
									});
								}
							});
						}
					},
					error: function(error){
						console.log(error);
					}
				});//$.ajax
			} //getSoundlist()

			$('#sound').click(function(){

				let showSoundlist =  $('#showSoundlist');
				showSoundlist.empty();
				// console.log('systemSoundlist: ' + JSON.Stringify(systemSoundlist));
				if(systemSoundlist.length>0){
					for(var i = 0; i < systemSoundlist.length; i++){
						showSoundlist.append('<div class="row"><div class="col-md-3">' + systemSoundlist[i].fileName + '</div><div class="col-md-3">' + systemSoundlist[i].fileTS +
						'</div><div class="col-md-1">'+
						'<a href="#" data-form="{"soundid":'+ systemSoundlist[i].fileID +'}" id="'+ systemSoundlist[i].fileID +
						'"><span data-icon="mdi-close-circle" class="iconify alert-danger"></span></a></div></div>');
					}
				}
				else{
					showSoundlist.append('<p style="font-weight: bold; color:red">No sound files found!</p>');
				}


			});//$('#sound').click(function()

			//sound hochladen
			$('#btnUPLOAD').click(function(){
				var formData = new FormData();
				let auth = localStorage.auth;
				let couser = localStorage.couserID;
				let fileName = $('#inputFILE')[0].files[0].name;

				// console.log('auth=>',auth);
				// console.log('couser=>',couser);
				// console.log('fileName=>',fileName);
				// console.log('file=>',$('#inputFILE')[0].files[0]);
				//
				formData.append("file", $('#inputFILE')[0].files[0]);
				console.log($('#inputFILE')[0].files[0]);
				formData.append('auth',auth);
				formData.append('name',fileName);
					formData.append('couser',couser);
					$.ajax({
						type: 'POST',
						url: 'https://apiqa.yoummday.com/vacd/uploadsound',
						data: formData,
						cache: false,
						contentType: false,
						processData: false,
						success: function(data)
						{
							if(data['error'] !== 'wrongfile'){
								alert('Prima, hochgeladen!');
								console.log('hochgeladen!');
								location.reload();
							}else{
								alert('Datei Type ist falsch! Bitte nur die wav Dateitype hochladen!');
								console.log(data['error']);
							}

							// location.reload();
							// $('#inputFILE')[0].files[0].clear;
							// console.log($('#inputFILE')[0].files[0]);
						},
						error: function(error){
							console.log(error);
						}
					});//$.ajax

			});//$('#btnUPLOAD').click

			// $("#showSoundlist").click(function(){
			// 	// $("#showSoundlist").on('click', 'a[id^="deleteSnd_"]', function(){
			// 		const targetLinks = document.querySelectorAll('a[data-form]'); // querySelectorAll('a[id^="deleteSnd_"]')
			// 		for (let i = 0; i < targetLinks.length; i++) {
			// 			let soundid = $(targetLinks[i]).attr("id");
			// 			let soundelement = "#"+$(targetLinks[i]).attr("id");
			// 			$("#showSoundlist").on('click', soundelement, function(){
			// 				let index = systemSoundlist.findIndex(function(item, i){
			// 					return item.fileID === soundid;
			// 				});
			// 				console.log("searched index: "+index+ " for soundid: "+soundid);
			// 				$.ajax({
			// 					type: 'POST',
			// 					contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
			// 					dataType: "json",
			// 					data: {
			// 						auth: window.localStorage['auth'],
			// 						soundid: soundid
			// 					},
			// 					url: 'https://apiqa.yoummday.com/vacd/deletesound',
			// 					success: function(data)
			// 					{
			// 						// console.log('data=>',data);
			// 						console.log('Erfolgreich gelöscht!');
			// 						systemSoundlist.splice(index, 1);
			// 						location.reload();
			// 					},
			// 					error: function(error){
			// 						console.log(error);
			// 					}
			// 				});
			// 			});
			// 		}
			// 	});

				//Element löschen
				$('#showSoundlist').on('click','.col-md-1 a',function(e){
					e.preventDefault();
					// console.log($(this)[0].parentElement.parentElement);
					let parentElement = $(this)[0].parentElement.parentElement;
					// console.log(parentElement);
					let soundid = $(this)[0].attributes['data-form'].value.replace('{"soundid":','').replace('}','');

					// console.log(soundid);

					let auth = window.localStorage['auth'];
					// console.log(auth);
					$('.modal').removeClass('d-none');
					$('button[data-dismiss="modal"]').click(function(){
							$('.modal').addClass('d-none');
					});
					//////////////////////////////////////////////////////////////////
					$('#ja').click(function(){
						$.ajax({
							type: 'POST',
							contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
							dataType: "json",
							data: {
								auth:auth,
								soundid:soundid
							},
								url: 'https://apiqa.yoummday.com/vacd/deletesound',

							success: function(data)
							{
								console.log('data=>',data);
								parentElement.remove();
								// console.log(parentElement);
								$('.modal').addClass('d-none');
								// console.log($(this).closest('li'));
								location.reload();
							},
							error: function(error){
								console.log(error);
							}
						});//$.ajax

					});//#ja







				});



				//beim Abmelden, localStorage leeren
				$('#logout a').click(function(){
					localStorage.clear();
				});
		});//$(document).ready
	</script>

</body>
</html>
<!DOCTYPE html>
<html>
<head>
	<title>VACD</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png" sizes="32x32" href="meta/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="meta/favicon-16x16.png">
	<link rel="icon" type="image/png" href="meta/favicon.ico">
	<link rel="mask-icon" href="meta/safari-pinned-tab.svg" color="#ce470a">
	<link rel="stylesheet" type="text/css" href="css/_plug/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/forms.css">
	<link rel="stylesheet" type="text/css" href="css/yd.css">
	<link rel="stylesheet" type="text/css" href="css/buttons.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" href="./js/jq/jquery-ui.min.css">
	<script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script>

</head>
<body translate="no">
	<article class="row no-gutters">
		<aside class="col-auto">
			<a href="/" class="logo bone"><div></div></a>
			<nav class="bone mb-5" id="back"></nav>
			<nav class="bone" id="nav">
				<a href="reteflow_number.html" id="telNumber" >Nummer</a>
				<a href="reteflow_callflow.html" id="callflow">Callflow</a>
				<a href="reteflow_sound.html" id="sound">Sounds</a>
			</nav>
			<footer>
				<nav class="bone">
					<!-- <a href="#" id="test">TEST</a> -->
					<!-- <a href="#" id="generator">Generate</a> -->
				</nav>

				<small  id="logout">
					<a href="index.html">abmelden
						<!-- <img src="//assets.yoummday.com/icons/mdi-reload.svg?color=%23eb6608" style="width:16px;"> -->
					</a>
				</small>
			</footer>
		</aside>
		<div class="col row no-gutters flex-column">
			<header class="bone text-center">
				<div class="row">
					<div class="container p-2">
						<div class="row justify-content-between">
					    <div class="col-4">
					      <span class="font-weight-bold text-uppercase "><label id="custom" ></label></span>
								<!-- <span class="iconify" data-icon="mdi:arrow-left-bold-circle-outline" data-inline="false"></span> -->
					    </div>
					    <div class="col-4">
					      <span class="font-weight-bold text-uppercase" id="head"><label for="worktype_label" id="worktype_label"></label></span>
					    </div>
					  </div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-8"></div>
				</div>
			</header>
			<div class="content col">

				<!-- Editor und Anrufverlaufliste -->
				<div class="row justify-content-around editorbox">

					<!-- Leftsite / Editor -->
					<div class="col-sm-6 col-md-9" id="leftSite">
							<!-- Number -->
						<div class="card" id='number'>
							<div class="card-body">
								<!-- Telefonnummerliste und Sound upload-->
								<div class="row">
										<!-- Number und Anrufverlaufliste-->
										<div class=" col">

											<div class=" justify-content-around" >
													<h2>Number</h2>
												<div class="row">
											    <div class="col-md-4" id="resultat">
														<table class="table table-striped table-bordered table-hover table-condensed" ></table>
													</div><!-- #resultat -->
											  </div>
												<div class="row">
													<div class="col">
														<h3 class="mt-5">Auftrag</h3>
														<div class="col" id="liste">
															<ul id="zettel"></ul>
															<table border="1" id="auftrag"></table>
															<!-- <form> -->
																<div class="row">
																	<div class="col-md-3" id="telNr"></div>
																	<div class="col-md-3" id='graphNAME'></div>
																	<div class="col-md-3" id="del"></div>
																</div>
															<!-- </form> -->
														</div>
													</div>
												</div><!-- row -->
												<div class="row mt-5">
													<div class="col-md-3" id='divTELNUMMER'>
																<label for="selectTelnummer">Telfonnummer:</label>
																<select id="selectTelnummer" size="">
																	<option value="#" selected>--</option>
																</select>
													</div><!-- divTELNUMMER-->

													<div class="col-md-3" id="divGRAFIKLIST">
														<label for="selectCallflow">Callflow</label>
														<select id="selectCallflow" class="selectCallflow" name="selectCallflow" >
															<option value="#" selected>--</option>
														</select>
													</div><!-- divGRAFIKLIST-->

													<div class="col-md-3" id="dataPicker" style="display: flex;align-items: start;flex-direction:column;">
														<label for="selectCallflow">Datum</label>
														<div class="row">
															<input class="datepicker" data-date-format="yyyy-mm-dd">
															<input type="time" name="time" id="time">
														</div>
													</div>
													<div class="col-md-3" id="divHinzuBtn" style="display: flex;align-items: center;">
														<input type="submit" class="btn btn-small btn-primary mt-3" id="hinzu" value="speichern" />
													</div>

												</div>
											</div>
										</div><!--id='number'-->


								</div><!-- id='divSOUNDUPLOAD' -->

							</div>
						</div>

					</div>

				</div>

			</div>
		</div>
		<div class="modal d-none" tabindex="-1">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title alert-warning">ACHTUNG!</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <p>Wollen Sie wirklich löschen?</p>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-outline-primary" data-dismiss="modal">nein</button>
		        <button type="button" class="btn btn-outline-primary" id="ja">ja</button>
		      </div>
		    </div>
		  </div>
		</div>
	</article>


	<script src="./js/jquery-3.5.1.js"></script>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="./js/jq/vendor/jquery.ui.widget.js"></script>
	<script src="./js/jq/jquery.iframe-transport.js"></script>
	<script src="./js/jq/jquery.fileupload.js"></script>
	<script src="./js/dayjs.min.js"></script>
	<script src="./js/jq/jquery-ui.min.js"></script>

	<script type="text/javascript">

	let systemGraphlist = [];
	function saveTempCall(funktionsname, successfunction) {
		let auth = window.localStorage.getItem("auth");
		let graphid = window.localStorage['graphID'];
		let number = window.localStorage['telNr'];
		let inputData = $('.datepicker')[0].value;
		let inputTime = $('#time')[0].value;
		let startTS = inputData + ' ' + inputTime;
		window.localStorage.setItem('graphDatum',startTS);
		console.log('auth=>',auth);
		console.log('graphid=>',graphid);
		console.log('number=>',number);
		console.log('startTS=>',startTS);
		let graphlistitem = {};
		$.ajax({
			type:'POST',
			contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
			dataType: 'json',
			data: {
							auth:auth,
							graphid: graphid,
							number: number,
							startTS:startTS
						},
			url: 'https://apiqa.yoummday.com/vacd/'+funktionsname,
			success: function(result){
					if ("error" in result) {
						console.log(result["error"]);
						let row = $('#liste');
						let divColMd6 = document.createElement('div');
						divColMd6.setAttribute('class','col-md-6');
						divColMd6.setAttribute('class','offset-md-3');

						let divColAuto = document.createElement('div');
						divColAuto.setAttribute('class','col-auto');

						let divAlert = document.createElement('div');
						divAlert.setAttribute('class','alert alert-danger');

						if (result["error"] == "auth") {

							divAlert.append('WRONG AUTH');
							divColAuto.append(divAlert);
							divColMd6.append(divColAuto);
							row.append(divColMd6);

							// alert("WRONG AUTH");
						}

						console.log(result["error"]);
						return;
				}
				successfunction(result);
			},
			error: function (e) {
				console.log(e);
			}
		});
	}

	function backendCall(funktionsname, successfunction) {
		$.ajax({
			type:'GET',
			contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
			dataType: 'json',
			data: {
							auth:localStorage.auth,
							couser:localStorage.couserID
						},
			url: 'https://apiqa.yoummday.com/vacd/'+funktionsname,
			success: function(result) {
				let row = $('header .row');
				if ("error" in result) {
					if (result["error"] == "auth") {

						let divColMd6 = document.createElement('div');
						divColMd6.setAttribute('class','col-md-6');
						divColMd6.setAttribute('class','offset-md-3');

						let divColAuto = document.createElement('div');
						divColAuto.setAttribute('class','col-auto');

						let divAlert = document.createElement('div');
						divAlert.setAttribute('class','alert alert-danger');
						divAlert.append('WRONG AUTH');

						divColAuto.append(divAlert);
						divColMd6.append(divColAuto);
						row.append(divColMd6);
					}

					console.log(result["error"]);
					return;
				}
				successfunction(result);
			}
				,
			error: function (e) {
				console.log(e);
			}
		});
	}

	function loadNumberContent() {

		//Userdaten auflisten
		backendCall("couserslist",function(result){
			let span = document.createElement('span');
			let timeLabel = $('#worktype_label');



			let header = $('#custom');
			let a = document.createElement('a');
			let divBack = $('#back');
			let aBack = document.createElement('a');

			let backSpan = document.createElement('span');
			backSpan.setAttribute('class','iconify');
			backSpan.setAttribute('data-icon','mdi:arrow-left-bold-circle-outline');
			backSpan.setAttribute('data-inline','false');
			backSpan.setAttribute('data-width','20px');
			backSpan.setAttribute('data-height','20px');
			backSpan.setAttribute('style','color:#eb6608');
			backSpan.setAttribute('style','margin-right:5px');
			let backA = document.createElement('a');

			if(window.localStorage.getItem('couserNAME')){

				a.setAttribute('href','#');
				a.appendChild(document.createTextNode(window.localStorage['couserNAME']));

				backA.setAttribute('href','menu.html');
				backA.appendChild(backSpan);

			}else{
				a.appendChild(document.createTextNode(window.localStorage['name']));
				// a.appendChild(document.createTextNode('Firma hat keine Name'));
			}
				header.append(a);
				header.append(backA);

			let aMenu1 = $('#callflow');
			let aMenu2 = $('#sound');
			let couserLenght = window.localStorage['couserLenght'];
			let fullaccess = window.localStorage['fullaccess'];

			if(couserLenght > 1 || fullaccess === true){
				aMenu1.removeClass('hidden');
				aMenu2.removeClass('hidden')
			}



		});

		//Telnummer auflisten
		backendCall("numberoverview",function(result){

				window.localStorage.removeItem('telNr');
				console.log('result=>',result);

				//Tabelle bauen
				let table = $('#resultat table');
				table.empty();

				if(Object.keys(result).length > 0){

					// nummer
					let liste= result["numberlist"];

					Object.keys(liste).forEach(number => {
						let routing = liste[number];
						// routing == id vom routingid

						let lastupdate = routing["lastupdate"];
						let graph =routing["graph"];
						// let graphname =routing["graph"]["name"];
						let graphname = graph["name"];


						// console.log(number + ": " + graphname + " am " + lastupdate);
						let tr = document.createElement('tr');
						let tdTel = document.createElement('td');
						// tdTel.setAttribute('width','100%');
						tdTel.setAttribute('style','font-weight:bold');
						tdTel.append(number);

						let tdClf = document.createElement('td');
						// tdClf.setAttribute('width','100%');
						tdClf.append(graphname);


						tr.append(tdTel);
						tr.append(tdClf);
						table.append(tr);

						//Auftrag Telnummer Dropdown
						let select = $('#selectTelnummer');
						let option = document.createElement('option');

						option.setAttribute('value',number);
						option.append(number);

						select.append(option);

					});
					console.log("AUFTRÄGE");

					// auftrag -- erzeugt liste fuer temproutings
					liste= result["temproutinglist"];

					// let auftragstabelle = $('#auftrag');
					// auftragstabelle.empty();
					$('#liste').empty();
					Object.keys(liste).forEach(routingids => {
						let routing = liste[routingids];
						// routing == id vom routingid
						let routingid= routing["id"];
						let number = routing["phone"];
						let startTS = routing["startTS"];
						let graph =routing["graph"];
						// let graphname =routing["graph"]["name"];
						let graphname = graph["name"];
						let graphid = graph["id"];

						///////////////////////////////////////////////////////
						let div = $('#liste');
						let row = document.createElement('div');
						row.setAttribute('class','row p-2');

						let colmd3_1 = document.createElement('div');
						colmd3_1.setAttribute('class','col-md-3');
						colmd3_1.append(number);

						let colmd3_2 = document.createElement('div');
						colmd3_2.setAttribute('class','col-md-3');
						colmd3_2.append(graphname);

						let colmd3_3 = document.createElement('div');
						colmd3_3.setAttribute('class','col-md-3');
						colmd3_3.append(startTS);

						let colmd1 = document.createElement('div');
						colmd1.setAttribute('class','col-md-1');
						// colmd1.setAttribute('id',routingid);
						let a = document.createElement('a');
						a.setAttribute('href','#');
						// a.setAttribute('data-form','{"graphid":'+ routingid +'}');
						a.setAttribute('id',routingid);
						let span = document.createElement('span');
						span.setAttribute('data-icon','mdi-close-circle');
						span.setAttribute('class','iconify alert-danger delet');
						span.setAttribute('id',routingid);

						a.append(span);
						colmd1.append(a);

						row.append(colmd3_1);
						row.append(colmd3_2);
						row.append(colmd3_3);
						row.append(colmd1);

						div.append(row);


						///////////////////////////////////////////////////////

						graphlistitem = {
							fileID: routingid,
							fileName: graphname,
							fileTS: startTS
							// deleteBtnId: fileName.split(/\s/).join('')
						};
						// console.log('soundlistitem=>', soundlistitem);
						systemGraphlist.push(graphlistitem);
						// let tr = document.createElement('tr');
						// let tdTel = document.createElement('td');
						// tdTel.setAttribute('width','100%');
						// tdTel.setAttribute('style','font-weight:bold');
						// tdTel.append(number);
						//
						// let tdClf = document.createElement('td');
						// tdClf.setAttribute('width','100%');
						// tdClf.append(graphname);
						//
						// let tdDate = document.createElement('td');
						// tdDate.setAttribute('width','100%');
						// tdDate.append(startTS);
						// tdDate.click(function() {
						// 	alert('test');
						// });
						//
						// tr.append(tdTel);
						// tr.append(tdClf);
						// tr.append(tdDate);
						// auftragstabelle.append(tr);



						//console.log(phone + ": " + graphname + " am " + startTS);

					});

					// Callflow
					liste= result["graphlist"];
					Object.keys(liste).forEach(graph => {

						let graphlist = liste[graph];
						let graphName = graphlist["name"];
						let graphId = graphlist["id"];

						//Auftrag Callflow Dropdown
						let select = $('#selectCallflow');
						let option = document.createElement('option');

						option.setAttribute('value',graphId);
						option.append(graphName);

						select.append(option);

					});


				}



			});



	}

	function saveTempCallflow(){
		saveTempCall("temprouting",function(result){
			console.log('result=>',result);

				if(result.success == 1){
					// alert('Danke Erfolgreich gespeichert!');
					console.log('geklappt!');
					// location.reload();
						let number = window.localStorage['telNr'];
						let graphname = window.localStorage['graphNAME'];
						let startTS = window.localStorage['graphDatum'];
						let graphId = window.localStorage['graphID'];

						///////////////////////////////////////////////////////

						let div = $('#liste');
						let row = document.createElement('div');
						row.setAttribute('class','row p-2');

						let colmd3_1 = document.createElement('div');
						colmd3_1.setAttribute('class','col-md-3');
						colmd3_1.append(number);

						let colmd3_2 = document.createElement('div');
						colmd3_2.setAttribute('class','col-md-3');
						colmd3_2.append(graphname);

						let colmd3_3 = document.createElement('div');
						colmd3_3.setAttribute('class','col-md-3');
						colmd3_3.append(startTS);

						let colmd1 = document.createElement('div');
						colmd1.setAttribute('class','col-md-1');
						let a = document.createElement('a');
						a.setAttribute('href','#');
						// a.setAttribute('data-form','{"graphid":'+ graphId +'}');
						a.setAttribute('id',graphId);
						let span = document.createElement('span');
						span.setAttribute('data-icon','mdi-close-circle');
						span.setAttribute('class','iconify alert-danger');

						a.append(span);
						colmd1.append(a);

						row.append(colmd3_1);
						row.append(colmd3_2);
						row.append(colmd3_3);
						row.append(colmd1);

						div.append(row);


						///////////////////////////////////////////////////////

						window.localStorage.removeItem('graphDatum');
						window.localStorage.removeItem('telNr');
						$('.datepicker')[0].value = "";
						$('#time')[0].value = "";
						console.log($('#selectCallflow option:selected'));
						// $('#selectCallflow option:selected').empty();
						// $('#selectTelnummer option:selected').empty();
						// location.reload();
				}else{
					console.log(result);
				}
			});
	}



	$(document).ready(function(){

		//#number Container anzeigen
		loadNumberContent();
		$('#telNumber').click(loadNumberContent);
		$('.datepicker').datepicker({dateFormat:'yy-mm-dd'});

		//Telnummer Auswählen
		$('#selectTelnummer').change(function(){
			$('#selectTelnummer option:selected').each(function(){
				console.log($(this).text());
				let telNr = $(this).text();
				window.localStorage.removeItem('telNr');
				window.localStorage.setItem('telNr',telNr);
			});
		});

		//Grafik Auswählen
		$('#selectCallflow').change(function(){
			$('#selectCallflow option:selected').each(function(){
				console.log($(this).val());
				let graphid = $(this).val();
				let graphname = $(this).text();
				window.localStorage.removeItem('graphID');
				window.localStorage.removeItem('graphNAME');
				window.localStorage.setItem('graphID',graphid);
				window.localStorage.setItem('graphNAME',graphname);
			});
		});


		//Neue Grafik für bestimmte Datum speichern
		$('#hinzu').click(saveTempCallflow);

		//Element löschen
		$('#liste').on('click','.col-md-1 a',function(){
			// console.log($(this)[0].parentElement.parentElement);
			let parentElement = $(this)[0].parentElement.parentElement;
			// console.log();
			let graphid = $(this)[0].id;
			let auth = window.localStorage['auth'];
			let couserID = window.localStorage['couserID'];

			$('.modal').removeClass('d-none');
			$('button[data-dismiss="modal"]').click(function(){
					$('.modal').addClass('d-none');
			});
			//////////////////////////////////////////////////////////////////
			$('#ja').click(function(){
				$.ajax({
					type: 'POST',
					contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
					dataType: "json",
					data: {
						auth:auth,
						couser:couserID,
						routingid:graphid
					},
						url: 'https://apiqa.yoummday.com/vacd/deletetemprouting',

					success: function(data)
					{
						console.log('data=>',data);
						parentElement.remove();
						// console.log(parentElement);
						$('.modal').addClass('d-none');
						// console.log($(this).closest('li'));
						// location.reload();
					},
					error: function(error){
						console.log(error);
					}
				});//$.ajax

			});//#ja







		});



		//beim Abmelden, localStorage leeren
		$('#logout a').click(function(){
			localStorage.clear();
		});


		});//$(document).ready
	</script>
</body>
</html>